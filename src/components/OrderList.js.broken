import React, { useState, useEffect } from 'react';
import axios from 'axios';
import AddOrderForm from './AddOrderForm';
import EditOrderForm from './EditOrderForm';
import DeleteOrderConfirmation from './DeleteOrderConfirmation';
          if (matches) {
            console.log(`âœ… MATCH FOUND: Order ${orderIdValue} has item ${item.id} (${item.product?.name || 'N/A'})`);
          }
          return matches;
        });OrderForm';
// import OrderDetails from './OrderDetails';
import DeleteOrderConfirmation from './DeleteOrderConfirmation';
import { formatPrice } from '../utils/priceFormatter';
import '../styles/OrderForms.css';

const OrderList = () => {
  // Main state
  const [orders, setOrders] = useState([]);
  const [filteredOrders, setFilteredOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  // Filter states
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [customerFilter, setCustomerFilter] = useState('all');
  const [dateFilter, setDateFilter] = useState('all');
  const [sortBy, setSortBy] = useState('recent');

  // Modal states
  const [showAddForm, setShowAddForm] = useState(false);
  const [editOrder, setEditOrder] = useState(null);
  const [viewOrder, setViewOrder] = useState(null);
  const [deleteOrder, setDeleteOrder] = useState(null);

  // Reference data
  const [customers, setCustomers] = useState([]);
  const [products, setProducts] = useState([]);

  // User permissions
  const [userRole] = useState('manager'); // TODO: Get from auth context

  useEffect(() => {
    fetchOrders();
    fetchReferenceData();
  }, []);

  // Filter and search logic
  useEffect(() => {
    let filtered = [...orders];

    // Search by customer name or order ID
    if (searchTerm) {
      filtered = filtered.filter(order =>
        order.customer.toLowerCase().includes(searchTerm.toLowerCase()) ||
        order.id.toString().includes(searchTerm)
      );
    }

    // Filter by status
    if (statusFilter !== 'all') {
      filtered = filtered.filter(order => order.status === statusFilter);
    }

    // Filter by customer
    if (customerFilter !== 'all') {
      filtered = filtered.filter(order => order.customer === customerFilter);
    }

    // Filter by date range
    if (dateFilter !== 'all') {
      const today = new Date();
      let filterDate = new Date();
      
      switch (dateFilter) {
        case 'today':
          filterDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          filterDate.setDate(today.getDate() - 7);
          break;
        case 'month':
          filterDate.setMonth(today.getMonth() - 1);
          break;
        default:
          filterDate = null;
      }

      if (filterDate) {
        filtered = filtered.filter(order => new Date(order.order_date) >= filterDate);
      }
    }

    // Sort orders
    filtered.sort((a, b) => {
      switch (sortBy) {
        case 'recent':
          return new Date(b.order_date) - new Date(a.order_date);
        case 'oldest':
          return new Date(a.order_date) - new Date(b.order_date);
        case 'customer':
          return a.customer.localeCompare(b.customer);
        case 'total':
          return parseFloat(b.total) - parseFloat(a.total);
        case 'status':
          return a.status.localeCompare(b.status);
        default:
          return new Date(b.order_date) - new Date(a.order_date);
      }
    });

    setFilteredOrders(filtered);
  }, [orders, searchTerm, statusFilter, customerFilter, dateFilter, sortBy]);

  const fetchOrders = async () => {
    try {
      setLoading(true);
      setError('');

      console.log('ğŸ”„ Fetching all data with relationships...');

      // Fetch all paginated data from each endpoint
      const fetchAllData = async (endpoint) => {
        let allData = [];
        let nextUrl = `http://localhost:8000/api/${endpoint}/`;
        
        while (nextUrl) {
          const response = await axios.get(nextUrl);
          allData = [...allData, ...(response.data.results || [])];
          nextUrl = response.data.next;
        }
        
        return allData;
      };

      // Fetch all related data concurrently
      const [ordersData, orderItemsData, discountsData] = await Promise.all([
        fetchAllData('orders'),
        fetchAllData('order-items'),
        fetchAllData('discounts')
      ]);

      console.log('ğŸ“Š Complete Data Analysis:', {
        orders: ordersData.length,
        orderItems: orderItemsData.length,
        discounts: discountsData.length
      });

      // Debug: Check data types and relationships
      console.log('ï¿½ Relationship Debug:', {
        sampleOrder: ordersData[0],
        sampleOrderItem: orderItemsData[0],
        sampleDiscount: discountsData[0]
      });

      // Create comprehensive order relationships with proper type handling
      const enrichedOrders = ordersData.map(order => {
        // Find all items for this order - Handle type coercion
        const orderItems = orderItemsData.filter(item => {
          const itemOrderId = parseInt(item.order);
          const orderIdValue = parseInt(order.id);
          console.log(`ğŸ”— Matching: item.order (${itemOrderId}) === order.id (${orderIdValue})`);
          return itemOrderId === orderIdValue;
        });

        // Find all discounts for order items
        const orderDiscounts = discountsData.filter(discount => {
          return orderItems.some(item => discount.order_item === item.id);
        });

        // Calculate base total price
        const baseTotal = orderItems.reduce((sum, item) => {
          const itemTotal = parseFloat(item.price || 0) * parseFloat(item.quantity || 0);
          console.log(`ğŸ’° Item ${item.id}: ${item.price} Ã— ${item.quantity} = ${itemTotal}`);
          return sum + itemTotal;
        }, 0);

        // Calculate total discount amount
        const totalDiscount = orderDiscounts.reduce((sum, discount) => {
          return sum + parseFloat(discount.discount_amount || 0);
        }, 0);

        // Final total after discounts
        const finalTotal = baseTotal - totalDiscount;

        console.log(`ğŸ“‹ Order ${order.id}: ${orderItems.length} items, Base: â‚¦${baseTotal.toFixed(2)}, Discount: â‚¦${totalDiscount.toFixed(2)}, Final: â‚¦${finalTotal.toFixed(2)}`);

        return {
          ...order,
          itemCount: orderItems.length,
          baseTotal: baseTotal,
          totalDiscount: totalDiscount,
          totalPrice: finalTotal,
          items: orderItems,
          discounts: orderDiscounts
        };
      });

      console.log('âœ… Enriched orders:', enrichedOrders.length);
      setOrders(enrichedOrders);

    } catch (error) {
      console.error('âŒ Error fetching orders:', error);
      setError('Failed to fetch orders: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const fetchReferenceData = async () => {
    try {
      const [customersResponse, productsResponse] = await Promise.all([
        axios.get('http://localhost:8000/api/customers/'),
        axios.get('http://localhost:8000/api/products/')
      ]);

      setCustomers(customersResponse.data.results || customersResponse.data);
      setProducts(productsResponse.data.results || productsResponse.data);
    } catch (error) {
      console.error('Error fetching reference data:', error);
    }
  };

  const getStatusInfo = (status) => {
    switch (status.toLowerCase()) {
      case 'pending':
        return { class: 'pending', icon: 'â³', color: '#f39c12' };
      case 'processing':
        return { class: 'processing', icon: 'ğŸ”„', color: '#3498db' };
      case 'completed':
        return { class: 'completed', icon: 'âœ…', color: '#27ae60' };
      case 'cancelled':
        return { class: 'cancelled', icon: 'âŒ', color: '#e74c3c' };
      default:
        return { class: 'unknown', icon: 'â“', color: '#95a5a6' };
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const clearFilters = () => {
    setSearchTerm('');
    setStatusFilter('all');
    setCustomerFilter('all');
    setDateFilter('all');
    setSortBy('recent');
  };

  // CRUD Handlers
  const handleAddOrder = () => {
    setShowAddForm(true);
  };

  const handleOrderAdded = (newOrder) => {
    setShowAddForm(false);
    fetchOrders(); // Refresh to get updated data
  };

  const handleEditOrder = (order) => {
    setEditOrder(order);
  };

  const handleOrderUpdated = (updatedOrder) => {
    setEditOrder(null);
    fetchOrders(); // Refresh to get updated data
  };

  const handleViewOrder = (order) => {
    setViewOrder(order);
  };

  const handleDeleteOrder = (order) => {
    setDeleteOrder(order);
  };

  const handleOrderDeleted = (deletedOrderId) => {
    setOrders(prev => prev.filter(o => o.id !== deletedOrderId));
    setDeleteOrder(null);
  };

  // Quick status update
  const updateOrderStatus = async (orderId, newStatus) => {
    try {
      await axios.patch(`http://localhost:8000/api/orders/${orderId}/`, {
        status: newStatus
      });
      
      setOrders(prev => prev.map(order => 
        order.id === orderId ? { ...order, status: newStatus } : order
      ));
    } catch (error) {
      console.error('Error updating order status:', error);
      alert('Failed to update order status');
    }
  };

  if (loading) {
    return (
      <div className="order-list-container">
        <div className="loading-state">
          <div className="loading-spinner"></div>
          <h3>Loading orders...</h3>
          <p>Please wait while we fetch the order data</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="order-list-container">
        <div className="error-state">
          <h3>âŒ Error Loading Orders</h3>
          <p>{error}</p>
          <button onClick={fetchOrders} className="retry-btn">
            ğŸ”„ Try Again
          </button>
        </div>
      </div>
    );
  }

  const uniqueCustomers = [...new Set(orders.map(order => order.customer))];

  return (
    <div className="order-list-container">
      {/* Header */}
      <div className="page-header">
        <h1>ğŸ›’ Order Management</h1>
        <div className="header-actions">
          <button onClick={fetchOrders} className="refresh-btn">
            ğŸ”„ Refresh Orders
          </button>
          {(userRole === 'manager' || userRole === 'sales') && (
            <button onClick={handleAddOrder} className="add-order-btn">
              â• Create New Order
            </button>
          )}
        </div>
      </div>

      {/* Filters Section */}
      <div className="filters-section">
        <div className="search-controls">
          <div className="search-bar">
            <input
              type="text"
              placeholder="Search by customer name or order ID..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="search-input"
            />
          </div>

          <div className="filter-controls">
            <div className="filter-group">
              <label>Status:</label>
              <select
                value={statusFilter}
                onChange={(e) => setStatusFilter(e.target.value)}
                className="filter-select"
              >
                <option value="all">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Processing">Processing</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>

            <div className="filter-group">
              <label>Customer:</label>
              <select
                value={customerFilter}
                onChange={(e) => setCustomerFilter(e.target.value)}
                className="filter-select"
              >
                <option value="all">All Customers</option>
                {uniqueCustomers.map(customer => (
                  <option key={customer} value={customer}>{customer}</option>
                ))}
              </select>
            </div>

            <div className="filter-group">
              <label>Date:</label>
              <select
                value={dateFilter}
                onChange={(e) => setDateFilter(e.target.value)}
                className="filter-select"
              >
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
            </div>

            <div className="filter-group">
              <label>Sort By:</label>
              <select
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
                className="filter-select"
              >
                <option value="recent">Most Recent</option>
                <option value="oldest">Oldest First</option>
                <option value="customer">Customer Name</option>
                <option value="total">Highest Total</option>
                <option value="status">Status</option>
              </select>
            </div>

            <button onClick={clearFilters} className="clear-filters-btn">
              Clear Filters
            </button>
          </div>
        </div>

        <div className="results-info">
          Showing {filteredOrders.length} of {orders.length} orders
        </div>
      </div>

      {/* Order Statistics */}
      <div className="order-stats">
        <div className="stat-card">
          <div className="stat-icon">ğŸ›’</div>
          <div className="stat-info">
            <h3>{orders.length}</h3>
            <p>Total Orders</p>
          </div>
        </div>
        
        <div className="stat-card">
          <div className="stat-icon">âœ…</div>
          <div className="stat-info">
            <h3>{orders.filter(o => o.status === 'Completed').length}</h3>
            <p>Completed</p>
          </div>
        </div>
        
        <div className="stat-card">
          <div className="stat-icon">â³</div>
          <div className="stat-info">
            <h3>{orders.filter(o => o.status === 'Pending').length}</h3>
            <p>Pending</p>
          </div>
        </div>
        
        <div className="stat-card">
          <div className="stat-icon">ğŸ’°</div>
          <div className="stat-info">
            <h3>{formatPrice(orders.reduce((sum, o) => sum + (o.totalPrice || 0), 0))}</h3>
            <p>Total Value (After Discounts)</p>
          </div>
        </div>
      </div>

      {/* Orders Table */}
      <div className="orders-section">
        <h2>Orders List</h2>
        
        {filteredOrders.length === 0 ? (
          <div className="no-orders">
            {orders.length === 0 ? (
              <>
                <h3>No Orders Yet</h3>
                <p>Start processing orders by creating your first order</p>
                <button onClick={handleAddOrder} className="add-first-order-btn">
                  â• Create First Order
                </button>
              </>
            ) : (
              <p>No orders match your search criteria. Try adjusting your filters.</p>
            )}
          </div>
        ) : (
          <div className="orders-table-container">
            <table className="orders-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Items</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredOrders.map(order => {
                  const statusInfo = getStatusInfo(order.status);
                  return (
                    <tr key={order.id}>
                      <td>
                        <div className="order-id">
                          <strong>#{order.id}</strong>
                        </div>
                      </td>
                      <td>
                        <div className="customer-info">
                          <strong>{order.customer}</strong>
                          <small>by {order.user}</small>
                        </div>
                      </td>
                      <td>{formatDate(order.order_date)}</td>
                      <td>
                        <span className="item-count">
                          {order.itemCount} item{order.itemCount !== 1 ? 's' : ''}
                        </span>
                      </td>
                      <td className="amount">
                        <div className="price-breakdown">
                          <strong>{formatPrice(order.totalPrice || 0)}</strong>
                          {order.totalDiscount > 0 && (
                            <div className="discount-info">
                              <small>Base: {formatPrice(order.baseTotal)}</small>
                              <small className="discount">-{formatPrice(order.totalDiscount)}</small>
                            </div>
                          )}
                        </div>
                      </td>
                      <td>
                        <div className="status-cell">
                          <span 
                            className={`status-badge ${statusInfo.class}`}
                            style={{ backgroundColor: statusInfo.color }}
                          >
                            {statusInfo.icon} {order.status}
                          </span>
                          {(userRole === 'manager' || userRole === 'sales') && order.status !== 'Completed' && (
                            <div className="status-actions">
                              {order.status === 'Pending' && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'Processing')}
                                  className="status-btn process-btn"
                                  title="Start Processing"
                                >
                                  ğŸ”„
                                </button>
                              )}
                              {(order.status === 'Pending' || order.status === 'Processing') && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'Completed')}
                                  className="status-btn complete-btn"
                                  title="Mark Complete"
                                >
                                  âœ…
                                </button>
                              )}
                            </div>
                          )}
                        </div>
                      </td>
                      <td>
                        <div className="action-buttons">
                          <button
                            onClick={() => handleViewOrder(order)}
                            className="action-btn view-btn"
                            title="View Details"
                          >
                            ğŸ‘ï¸
                          </button>
                          <button
                            onClick={() => handleEditOrder(order)}
                            className="action-btn edit-btn"
                            disabled={userRole === 'viewer' || order.status === 'Completed'}
                            title="Edit Order"
                          >
                            âœï¸
                          </button>
                          <button
                            onClick={() => handleDeleteOrder(order)}
                            className="action-btn delete-btn"
                            disabled={userRole !== 'manager' || order.status === 'Completed'}
                            title="Delete Order"
                          >
                            ğŸ—‘ï¸
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Modal Components */}
      {showAddForm && (
        <AddOrderForm
          onCancel={() => setShowAddForm(false)}
          onOrderAdded={handleOrderAdded}
          customers={customers}
          products={products}
          userRole={userRole}
        />
      )}

      {editOrder && (
        <EditOrderForm
          order={editOrder}
          onCancel={() => setEditOrder(null)}
          onOrderUpdated={handleOrderUpdated}
          customers={customers}
          products={products}
          userRole={userRole}
        />
      )}

      {viewOrder && (
        <div className="modal-overlay">
          <div className="order-details-modal">
            <div className="modal-header">
              <h2>ğŸ›’ Order Details - #{viewOrder.id}</h2>
              <button onClick={() => setViewOrder(null)} className="close-btn">âœ•</button>
            </div>
            <div className="modal-content">
              <p>Order details coming soon! (OrderDetails component temporarily disabled for testing)</p>
              <p><strong>Customer:</strong> {viewOrder.customer}</p>
              <p><strong>Status:</strong> {viewOrder.status}</p>
              <p><strong>Total:</strong> {formatPrice(viewOrder.total)}</p>
            </div>
            <div className="modal-footer">
              <button onClick={() => setViewOrder(null)} className="cancel-btn">Close</button>
            </div>
          </div>
        </div>
      )}

      {deleteOrder && (
        <DeleteOrderConfirmation
          order={deleteOrder}
          onCancel={() => setDeleteOrder(null)}
          onOrderDeleted={handleOrderDeleted}
          userRole={userRole}
        />
      )}
    </div>
  );
};

export default OrderList;